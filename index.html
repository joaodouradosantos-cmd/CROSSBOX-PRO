<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CrossBox</title>

  <meta name="theme-color" content="#f2f2f2" />
  <link rel="manifest" href="manifest.json" />

  <link rel="apple-touch-icon" sizes="180x180" href="imagens/crossbox_logo.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      font-family: system-ui, sans-serif;
      color-scheme: light;
    }

    body {
      background:
        /* RISCOS ESCUROS TIPO ARRANH√ïES */
        repeating-linear-gradient(
          145deg,
          rgba(18, 22, 15, 0.95) 0px,
          rgba(18, 22, 15, 0.95) 120px,
          rgba(12, 13, 10, 1) 121px,
          rgba(12, 13, 10, 1) 132px
        ),
        /* MANCHAS OLIVA / LAMA */
        radial-gradient(circle at 12% 0%, rgba(116, 128, 76, 0.55) 0, transparent 55%),
        radial-gradient(circle at 85% 100%, rgba(140, 110, 60, 0.45) 0, transparent 60%),
        /* FUNDO PRINCIPAL VERDE TROPA ESCURO */
        linear-gradient(to bottom, #4f5b32 0%, #262f1c 40%, #141710 100%);

      color: #111;
      display: flex;
      justify-content: center;
      min-height: 100vh;
      background-attachment: fixed;
    }

    .app {
      width: 100%;
      max-width: 900px;
      padding: 8px;
      box-sizing: border-box;
    }

    header {
      text-align: center;
      margin-bottom: 6px;
      position: relative;
    }

    #appLogo {
      max-width: 340px;
      height: auto;
      display: block;
      margin: 0 auto 0px auto;
    }

    .subtitle {
      font-size: 0.90rem;
      margin-top: -10px;
      color: #e0e5d8;
      cursor: pointer;
      text-decoration: none;
      text-shadow: 0 2px 3px rgba(0, 0, 0, 0.6);
      letter-spacing: 0.03em;
      transition: text-decoration 0.15s ease, transform 0.1s ease;
    }

    .subtitle:hover {
      text-decoration: underline;
      transform: translateY(-1px);
    }

    .card {
      background: #e1e1e1;
      background-image:
        linear-gradient(135deg, rgba(255, 255, 255, 0.18), rgba(180, 180, 180, 0.12)),
        repeating-linear-gradient(
          135deg,
          rgba(0, 0, 0, 0.09) 0px,
          rgba(0, 0, 0, 0.09) 1px,
          transparent 1px,
          transparent 4px
        );
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 16px;
      border: 1px solid #9d9d9d;
      box-shadow:
        0 4px 10px rgba(0, 0, 0, 0.35),
        inset 0 0 0 1px rgba(255, 255, 255, 0.06);
    }

    /* PERFIL SEM ‚ÄúCART√ÉO‚Äù VIS√çVEL */
    #perfil.card {
      background: transparent;
      border: none;
      box-shadow: none;
      padding: 0;
      margin-bottom: 4px;
    }

    #perfilForm {
      display: none;
      margin-bottom: 8px;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 8px;
    }

    .field {
      flex: 1;
      min-width: 140px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 0.8rem;
      color: #2b2b2b;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    input,
    select,
    textarea,
    button {
      padding: 10px;
      border-radius: 10px;
      background: #f8f8f8;
      color: #222;
      border: 1px solid #b7b7b7;
      font-size: 0.9rem;
      box-sizing: border-box;
      font-family: inherit;
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.25);
    }

    /* BOT√ÉO PRINCIPAL ‚Äì ESTILO GUERRA SUJA */
    .btn-primary {
      background:
        linear-gradient(145deg, #1f7b3a, #0f4220);
      border: 1px solid #050806;
      color: #f4f4f4;
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      box-shadow:
        0 3px 0 #050806,
        inset 0 0 0 1px rgba(255, 255, 255, 0.04);
      position: relative;
      overflow: hidden;
    }

    .btn-primary::after {
      content: "";
      position: absolute;
      inset: 0;
      background-image:
        repeating-linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.08) 0px,
          rgba(255, 255, 255, 0.08) 1px,
          transparent 1px,
          transparent 4px
        );
      mix-blend-mode: soft-light;
      opacity: 0.32;
      pointer-events: none;
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow:
        0 1px 0 #050806,
        inset 0 0 0 1px rgba(0, 0, 0, 0.3);
    }

    /* BOT√ïES SECUND√ÅRIOS ‚Äì RISCADOS / BATTLE WORN */
    .btn-secondary {
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #303030;
      background:
        linear-gradient(145deg, #3b3f3a, #202320);
      color: #f2f2f2;
      font-size: 0.8rem;
      cursor: pointer;
      white-space: nowrap;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      box-shadow:
        0 3px 0 #050807,
        inset 0 0 0 1px rgba(255, 255, 255, 0.03);
      position: relative;
      overflow: hidden;
    }

    .btn-secondary::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image:
        repeating-linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.07) 0px,
          rgba(255, 255, 255, 0.07) 1px,
          transparent 1px,
          transparent 5px
        );
      mix-blend-mode: soft-light;
      opacity: 0.28;
      pointer-events: none;
    }

    .btn-secondary:active {
      transform: translateY(1px);
      box-shadow: 0 1px 0 #050807;
    }

    /* BOT√ÉO APAGAR ‚Äì MANTIDO MAS MAIS ‚ÄúBRUTO‚Äù */
    .btn-delete {
      padding: 2px 4px;
      border-radius: 999px;
      border: 1px solid #3b0505;
      background:
        linear-gradient(145deg, #b93333, #7a1515);
      color: #ffffff;
      font-size: 0.75rem;
      cursor: pointer;
      box-shadow: 0 2px 0 #2a0202;
    }

    .btn-delete:hover {
      background: linear-gradient(145deg, #ef4444, #b91c1c);
    }

    .helper-text {
      margin-top: 4px;
      font-size: 0.8rem;
      color: #222;
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin: 10px 0 14px 0;
    }

    .tab-btn {
      flex: 1;
      padding: 10px 0;
      border-radius: 999px;
      border: 1px solid #202320;
      background:
        linear-gradient(145deg, #32372f, #21241f);
      color: #f1f1f1;
      cursor: pointer;
      font-size: 0.9rem;
      box-shadow:
        0 4px 0 #050806,
        inset 0 0 0 1px rgba(255, 255, 255, 0.04);
      transition:
        transform 0.1s ease,
        box-shadow 0.1s ease,
        background 0.1s ease,
        border-color 0.1s ease,
        color 0.1s ease;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      position: relative;
      overflow: hidden;
    }

    .tab-btn::before {
      content: "";
      position: absolute;
      inset: 0;
      background-image:
        repeating-linear-gradient(
          135deg,
          rgba(255, 255, 255, 0.08) 0px,
          rgba(255, 255, 255, 0.08) 1px,
          transparent 1px,
          transparent 4px
        );
      mix-blend-mode: soft-light;
      opacity: 0.3;
      pointer-events: none;
    }

    .tab-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 5px 0 #040605;
    }

    .tab-btn.active {
      background:
        linear-gradient(145deg, #1f7b3a, #0f4220);
      border-color: #0b2614;
      color: #ffffff;
      font-weight: 700;
      transform: translateY(2px);
      box-shadow: 0 2px 0 #041207;
    }

    .section { display: none; }
    .section.active { display: block; }

    .options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
    }

    .opt-btn {
      width: 100%;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }

    .opt-emoji {
      font-size: 1.4rem;
    }

    .option-section {
      display: none;
    }

    .option-section.active {
      display: block;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      color: #111;
    }

    th,
    td {
      padding: 6px;
      text-align: center;
      border-bottom: 1px solid #d9d9d9;
      white-space: nowrap;
    }

    th {
      background: #d5d5d5;
      color: #222;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .scroll {
      max-height: 260px;
      overflow: auto;
      border-radius: 10px;
      border: 1px solid #b5b5b5;
      background: #f0f0f0;
    }

    #backupInfo {
      margin-top: 6px;
      font-size: 0.75rem;
      color: #222;
    }

    /* REMOVER RISCOS APENAS NO CARD "REGISTO E HIST√ìRICO" */
    #opt-wod .card:nth-of-type(2) {
      background-image: none !important;
      background-color: #e1e1e1 !important;
    }
    
  </style>
</head>
<body>
<div class="app">

  <header>
    <img id="appLogo" src="imagens/crossbox_logo.png" alt="Cross Moita Logo">
    <div class="subtitle" id="appSubtitle">Registo de treinos</div>
      </header>

  <!-- PERFIL -->
  <section class="card" id="perfil">
    <div id="perfilForm">
      <div class="form-row">
        <div class="field">
          <label>Nome</label>
          <input id="nome" type="text" />
        </div>
        <div class="field">
          <label>N√≠vel</label>
          <select id="nivel">
            <option value="">Selecionar</option>
            <option value="iniciante">Iniciante</option>
            <option value="intermedio">Interm√©dio</option>
            <option value="avancado">Avan√ßado</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="field">
          <label>Sexo</label>
          <select id="sexo">
            <option value="">Selecionar</option>
            <option value="masculino">Masculino</option>
            <option value="feminino">Feminino</option>
          </select>
        </div>
        <div class="field">
          <label>Idade</label>
          <input id="idade" type="number" min="10" max="100" />
        </div>
      </div>

      <div class="form-row">
        <div class="field">
          <label>Altura (cm)</label>
          <input id="altura" type="number" min="100" max="230" />
        </div>
        <div class="field">
          <label>Peso (kg)</label>
          <input id="peso" type="number" min="30" max="250" step="0.1" />
        </div>
      </div>

      <div class="form-row">
        <button class="btn-primary" id="guardarPerfil">Guardar perfil</button>
        <button class="btn-secondary" id="togglePerfilForm">Mostrar / Ocultar perfil</button>
      </div>
    </div>

    <div id="perfilResumo" class="helper-text"></div>
  </section>

  <!-- TABS PRINCIPAIS -->
  <div class="tabs">
    <button class="tab-btn active" data-target="sec-wod">WOD & Tools</button>
    <button class="tab-btn" data-target="sec-historico">Hist√≥rico</button>
    <button class="tab-btn" data-target="sec-analise">An√°lise & Notas</button>
  </div>

  <!-- SEC√á√ÉO WOD & TOOLS -->
  <section id="sec-wod" class="section active">
    <div class="card">
      <h3 style="margin-top:0; margin-bottom:8px;">üß∞ WOD & Tools</h3>
      <p class="helper-text" style="margin-bottom:10px;">
        Regista os teus treinos, acompanha 1RM, objetivos, gr√°ficos e desempenho semanal. Usa tamb√©m o guia de exerc√≠cios e o backup de dados.
      </p>

      <div class="options-grid">
        <button class="btn-secondary opt-btn" data-target="opt-wod">
          <span class="opt-emoji">üü©</span>
          <span>WOD</span>
        </button>
        <button class="btn-secondary opt-btn" data-target="opt-calc">
          <span class="opt-emoji">üßÆ</span>
          <span>Objetivo</span>
        </button>
        <button class="btn-secondary opt-btn" data-target="opt-graficos">
          <span class="opt-emoji">üìà</span>
          <span>Gr√°fico</span>
        </button>
        <button class="btn-secondary opt-btn" data-target="opt-performance">
          <span class="opt-emoji">üèÖ</span>
          <span>Desempenho</span>
        </button>
        <button class="btn-secondary opt-btn" data-target="opt-guia">
          <span class="opt-emoji">üìö</span>
          <span>Exerc√≠cios</span>
        </button>
        <button class="btn-secondary opt-btn" data-target="opt-backup">
          <span class="opt-emoji">üíæ</span>
          <span>Backup</span>
        </button>
        <!-- NOVO BOT√ÉO RESERVAS -->
        <button class="btn-secondary opt-btn" data-target="sec-reservas">
          <span class="opt-emoji">üìÜ</span>
          <span>Reservas</span>
        </button>
      </div>
      <div class="helper-text" style="margin-top:8px;">
      </div>
    </div>

    <!-- WOD -->
    <section id="opt-wod" class="option-section">
      <div class="card">
        <h3 style="margin-top:0; margin-bottom:8px;">üü© WOD</h3>

        <div class="form-row">
          <div class="field">
            <label>Data</label>
            <input id="treinoData" type="date">
          </div>
          <div class="field">
            <label>Exerc√≠cio</label>
            <input id="treinoExercicioSearch" type="text" placeholder="Procurar exerc√≠cio..." />
            <select id="treinoExercicio"></select>
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Tipo</label>
            <select id="treinoTipo">
              <option value="">Selecionar</option>
              <option value="For√ßa">For√ßa</option>
              <option value="Metcon">Metcon</option>
              <option value="T√©cnica">T√©cnica</option>
              <option value="Mobilidade">Mobilidade</option>
            </select>
          </div>
          <div class="field">
            <label>Rondas / S√©ries</label>
            <input id="treinoRondas" type="number" min="1" />
          </div>
          <div class="field">
            <label>Repeti√ß√µes</label>
            <input id="treinoReps" type="number" min="1" />
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Peso (kg)</label>
            <input id="treinoPeso" type="number" step="0.5" min="0" />
          </div>
          <div class="field">
            <label>Tempo (mm:ss)</label>
            <input id="treinoTempo" type="text" placeholder="Ex.: 12:34" />
          </div>
          <div class="field">
            <label>Dist√¢ncia corrida (km)</label>
            <input id="treinoDistancia" type="number" step="0.01" min="0" />
          </div>
        </div>

        <div class="form-row">
          <button class="btn-primary" id="adicionarTreinoBtn">Registar WOD</button>
        </div>

        <div class="helper-text">
          A carga total √© calculada automaticamente (peso √ó reps √ó rondas). Usa a dist√¢ncia apenas em treinos com corrida.
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0; margin-bottom:8px;">üìú Registo e hist√≥rico do dia</h3>
        <div class="scroll">
          <table>
            <thead>
              <tr>
                <th>Data</th>
                <th>Exerc√≠cio</th>
                <th>Tipo</th>
                <th>Rds</th>
                <th>Reps</th>
                <th>Peso</th>
                <th>%1RM</th>
                <th>Tempo</th>
                <th>Dist√¢ncia</th>
                <th>Carga</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="dailyHistoryBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- CALCULADORA DE OBJETIVOS -->
    <section id="opt-calc" class="option-section">
      <div class="card">
        <h3 style="margin-top:0; margin-bottom:8px;">üéØ Objetivo de 1RM</h3>
        <div class="form-row">
          <div class="field">
            <label>Exerc√≠cio</label>
            <select id="calcExercise"></select>
          </div>
          <div class="field">
            <label>1RM atual (kg)</label>
            <input id="calcCurrentRm" type="number" step="0.5" min="0" />
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label>Objetivo (kg)</label>
            <input id="calcTargetRm" type="number" step="0.5" min="0" />
          </div>
          <div class="field">
            <label>Prazo (semanas)</label>
            <input id="calcWeeks" type="number" min="1" />
          </div>
        </div>
        <div class="form-row">
          <div class="field">
            <label>N√≠vel de experi√™ncia</label>
            <select id="calcNivel">
              <option value="">Usar n√≠vel do perfil</option>
              <option value="iniciante">Iniciante</option>
              <option value="intermedio">Interm√©dio</option>
              <option value="avancado">Avan√ßado</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <button class="btn-primary" id="calcBtn">Calcular plano</button>
        </div>
        <p id="calcResultado" class="helper-text"></p>
      </div>
    </section>

    <!-- GR√ÅFICOS -->
    <section id="opt-graficos" class="option-section">
      <div class="card">
        <h3 style="margin-top:0; margin-bottom:8px;">üìà Evolu√ß√£o de 1RM</h3>
        <div class="form-row">
          <div class="field">
            <label>Exerc√≠cio</label>
            <select id="graphExercise"></select>
          </div>
        </div>
        <canvas id="rmChart" height="220"></canvas>
      </div>
    </section>

    <!-- PERFORMANCE -->
    <section id="opt-performance" class="option-section">
      <div class="card">
        <h3 style="margin-top:0; margin-bottom:8px;">üèÖ Desempenho & carga semanal</h3>
        <div id="weeklyHistory"></div>

        <h4 style="margin-top:12px; margin-bottom:4px;">Top 1RM por exerc√≠cio</h4>
        <div class="scroll">
          <table>
            <thead>
              <tr>
                <th>Exerc√≠cio</th>
                <th>1RM (kg)</th>
                <th>Data</th>
                <th>R√°cio vs peso corporal</th>
              </tr>
            </thead>
            <tbody id="perf1rmBody"></tbody>
          </table>
        </div>

        <h4 style="margin-top:12px; margin-bottom:4px;">Metcon ‚Äì melhores tempos</h4>
        <div class="scroll">
          <table>
            <thead>
              <tr>
                <th>Exerc√≠cio</th>
                <th>Melhor tempo</th>
                <th>Data</th>
                <th>Carga / dist√¢ncia</th>
              </tr>
            </thead>
            <tbody id="perfMetconBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- GUIA EXERC√çCIOS -->
    <section id="opt-guia" class="option-section">
      <div class="card">
        <h3 style="margin-top:0; margin-bottom:8px;">üìö Guia de exerc√≠cios</h3>
        <input id="guiaSearch" type="text" placeholder="Procurar por nome (EN/PT) ou descri√ß√£o." />
        <div class="scroll" style="margin-top:8px;">
          <table>
            <thead>
              <tr>
                <th>Nome (EN)</th>
                <th>Tradu√ß√£o (PT)</th>
                <th>Descri√ß√£o</th>
              </tr>
            </thead>
            <tbody id="guiaBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- BACKUP -->
    <section id="opt-backup" class="option-section">
      <div class="card">
        <h3 style="margin-top:0; margin-bottom:8px;">üíæ Backup de dados</h3>
        <p class="helper-text">
          Exporta um ficheiro com o teu perfil, 1RM, hist√≥rico de WOD e restante informa√ß√£o.
          Podes guardar em Google Drive, iCloud, Ficheiros, etc. Para restaurar noutro telem√≥vel, basta importar o ficheiro.
        </p>
        <div class="form-row">
          <button class="btn-primary" id="exportBackupBtn">Exportar backup</button>
          <button class="btn-secondary" id="importBackupBtn">Importar backup</button>
          <input type="file" id="backupFileInput" accept="application/json" style="display:none;" />
        </div>
        <div id="backupInfo"></div>
      </div>
    </section>

  </section>

  <!-- RESERVAS & PRESEN√áAS (ALUNO) -->
  <section class="card" id="sec-reservas" style="display:none; margin-bottom:10px;">
    <h3 style="margin-top:0; margin-bottom:8px;">üìÜ Reservas & Presen√ßas</h3>

    <div class="form-row">
      <div class="field">
        <label>Data da aula</label>
        <input id="reservaData" type="date" />
      </div>
      <div class="field">
        <label>Hora</label>
        <input id="reservaHora" type="time" />
      </div>
    </div>

    <div class="form-row">
      <div class="field">
        <label>Tipo de aula</label>
        <select id="reservaTipo">
          <option value="">Selecionar</option>
          <option value="WOD">WOD</option>
          <option value="Open Box">Open Box</option>
          <option value="Halterofilismo">Halterofilismo</option>
          <option value="Mobilidade">Mobilidade</option>
          <option value="Competi√ß√£o">Competi√ß√£o</option>
        </select>
      </div>
      <div class="field">
        <label>Nota (opcional)</label>
        <input id="reservaNota" type="text" placeholder="Ex.: parceiro, foco, objetivo do dia..." />
      </div>
    </div>

    <button class="btn-primary" id="reservaAddBtn">Guardar reserva</button>

    <div class="helper-text" style="margin-top:6px;">
      Estas reservas e presen√ßas s√£o pessoais e ficam apenas guardadas neste dispositivo.
    </div>

    <div class="scroll" style="margin-top:10px;">
      <table>
        <thead>
          <tr>
            <th>Data</th>
            <th>Hora</th>
            <th>Aula</th>
            <th>Nota</th>
            <th>Presen√ßa</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="reservasBody"></tbody>
      </table>
    </div>

    <div class="helper-text" id="reservasResumo" style="margin-top:6px;"></div>
  </section>

  <!-- HIST√ìRICO (TAB 2) -->
  <section id="sec-historico" class="section">
    <div class="card">
      <h3 style="margin-top:0; margin-bottom:8px;">üìú Hist√≥rico completo de WOD</h3>
      <div class="scroll">
        <table>
          <thead>
            <tr>
              <th>Data</th>
              <th>Exerc√≠cio</th>
              <th>Tipo</th>
              <th>Rds</th>
              <th>Reps</th>
              <th>Peso</th>
              <th>%1RM</th>
              <th>Tempo</th>
              <th>Dist√¢ncia</th>
              <th>Carga</th>
            </tr>
          </thead>
          <tbody id="treinosBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- AN√ÅLISE & NOTAS (TAB 3) -->
  <section id="sec-analise" class="section">
    <div class="card">
      <h3 style="margin-top:0; margin-bottom:8px;">üß† An√°lise & notas pessoais</h3>
      <p class="helper-text">
        Usa este espa√ßo para apontar sensa√ß√µes de treino, estrat√©gias que resultaram ou ajustes a fazer.
      </p>
      <textarea id="notasAnalise" rows="6" placeholder="Ex.: hoje senti fadiga nas pernas, ajustar carga no pr√≥ximo treino..."></textarea>
      <div class="form-row" style="margin-top:8px;">
        <button class="btn-primary" id="guardarNotasAnalise">Guardar notas</button>
      </div>
      <p id="notasAnaliseInfo" class="helper-text"></p>
    </div>
  </section>

</div>

<script>
/* ===== CHAVES DE ARMAZENAMENTO ===== */
const STORAGE_PROFILE = "crossfit_profile";
const STORAGE_RM = "crossfit_1rm";
const STORAGE_RM_HISTORY = "crossfit_1rm_history";
const STORAGE_TREINO = "crossfit_treinos";
const STORAGE_BACKUP_META = "crossfit_backup_meta";

/* NOVOS ARMAZENAMENTOS */
const STORAGE_RESERVAS = "crossfit_reservas";
const STORAGE_PRESENCAS = "crossfit_presencas";
const STORAGE_RANKINGS = "crossfit_rankings";

/* ===== PERFIL ===== */
let profile = JSON.parse(localStorage.getItem(STORAGE_PROFILE) || "{}");

const nomeEl = document.getElementById("nome");
const nivelEl = document.getElementById("nivel");
const sexoEl = document.getElementById("sexo");
const idadeEl = document.getElementById("idade");
const alturaEl = document.getElementById("altura");
const pesoEl = document.getElementById("peso");
const guardarPerfilBtn = document.getElementById("guardarPerfil");
const togglePerfilFormBtn = document.getElementById("togglePerfilForm");
const perfilResumoEl = document.getElementById("perfilResumo");
const perfilFormEl = document.getElementById("perfilForm");

/* ===== TABS ===== */
const tabButtons = document.querySelectorAll(".tab-btn");
const sections = document.querySelectorAll(".section");

/* ===== WOD ===== */
const treinoDataEl = document.getElementById("treinoData");
const treinoExSearchEl = document.getElementById("treinoExercicioSearch");
const treinoExEl = document.getElementById("treinoExercicio");
const treinoTipoEl = document.getElementById("treinoTipo");
const treinoRondasEl = document.getElementById("treinoRondas");
const treinoRepsEl = document.getElementById("treinoReps");
const treinoPesoEl = document.getElementById("treinoPeso");
const treinoTempoEl = document.getElementById("treinoTempo");
const treinoDistEl = document.getElementById("treinoDistancia");
const adicionarTreinoBtn = document.getElementById("adicionarTreinoBtn");
const treinosBody = document.getElementById("treinosBody");
const dailyHistoryBody = document.getElementById("dailyHistoryBody");
const weeklyHistoryEl = document.getElementById("weeklyHistory");

/* ===== CALC OBJETIVOS ===== */
const calcExerciseEl = document.getElementById("calcExercise");
const calcCurrentRmEl = document.getElementById("calcCurrentRm");
const calcTargetRmEl = document.getElementById("calcTargetRm");
const calcWeeksEl = document.getElementById("calcWeeks");
const calcNivelEl = document.getElementById("calcNivel");
const calcBtn = document.getElementById("calcBtn");
const calcResEl = document.getElementById("calcResultado");

/* ===== GR√ÅFICO 1RM ===== */
const rmChartCanvas = document.getElementById("rmChart");
const graphExerciseEl = document.getElementById("graphExercise");
let rmChart = null;

/* ===== GUIA EXERC√çCIOS ===== */
const guiaBody = document.getElementById("guiaBody");
const guiaSearch = document.getElementById("guiaSearch");

/* ===== BACKUP ===== */
const exportBackupBtn = document.getElementById("exportBackupBtn");
const importBackupBtn = document.getElementById("importBackupBtn");
const backupFileInput = document.getElementById("backupFileInput");
const backupInfoEl = document.getElementById("backupInfo");

/* ===== RESERVAS & PRESEN√áAS ===== */
const reservasSection = document.getElementById("sec-reservas");
const reservaDataEl = document.getElementById("reservaData");
const reservaHoraEl = document.getElementById("reservaHora");
const reservaTipoEl = document.getElementById("reservaTipo");
const reservaNotaEl = document.getElementById("reservaNota");
const reservaAddBtn = document.getElementById("reservaAddBtn");
const reservasBody = document.getElementById("reservasBody");
const reservasResumoEl = document.getElementById("reservasResumo");

let reservas = JSON.parse(localStorage.getItem(STORAGE_RESERVAS) || "[]");
let presencas = JSON.parse(localStorage.getItem(STORAGE_PRESENCAS) || "[]");
let rankingsMensais = JSON.parse(localStorage.getItem(STORAGE_RANKINGS) || "[]");

function formatKg(v) {
  return v.toFixed(1).replace(".", ",") + " kg";
}

function formatKm(v) {
  return v.toFixed(2).replace(".", ",") + " km";
}

/* ===== PERFIL ===== */
function loadProfile() {
  if (!profile) profile = {};
  nomeEl.value = profile.nome || "";
  nivelEl.value = profile.nivel || "";
  sexoEl.value = profile.sexo || "";
  idadeEl.value = profile.idade || "";
  alturaEl.value = profile.altura || "";
  pesoEl.value = profile.peso || "";

  let resumo = "";
  if (profile.nome) resumo += `<strong>${profile.nome}</strong>`;
  if (profile.idade) resumo += `, ${profile.idade} anos`;
  if (profile.sexo) resumo += `, ${profile.sexo}`;
  if (profile.altura) resumo += `, ${profile.altura} cm`;
  if (profile.peso) resumo += `, ${profile.peso} kg`;
  if (profile.nivel) resumo += ` ‚Äì n√≠vel ${profile.nivel}`;

  perfilResumoEl.innerHTML = resumo || "Perfil ainda n√£o preenchido.";
}

function saveProfile() {
  profile = {
    nome: nomeEl.value.trim(),
    nivel: nivelEl.value,
    sexo: sexoEl.value,
    idade: idadeEl.value ? parseInt(idadeEl.value, 10) : "",
    altura: alturaEl.value ? parseInt(alturaEl.value, 10) : "",
    peso: pesoEl.value ? parseFloat(pesoEl.value) : ""
  };
  localStorage.setItem(STORAGE_PROFILE, JSON.stringify(profile));
  loadProfile();
  registerBackupMeta("Perfil atualizado");
}

if (guardarPerfilBtn) {
  guardarPerfilBtn.addEventListener("click", () => {
    saveProfile();
    alert("Perfil guardado.");
  });
}

if (togglePerfilFormBtn) {
  togglePerfilFormBtn.addEventListener("click", () => {
    if (perfilFormEl.style.display === "none" || !perfilFormEl.style.display) {
      perfilFormEl.style.display = "block";
    } else {
      perfilFormEl.style.display = "none";
    }
  });
}

/* ===== NOTAS AN√ÅLISE ===== */
const notasAnaliseEl = document.getElementById("notasAnalise");
const notasAnaliseBtn = document.getElementById("guardarNotasAnalise");
const notasAnaliseInfoEl = document.getElementById("notasAnaliseInfo");
const STORAGE_NOTAS = "crossfit_notas_analise";

function loadNotasAnalise() {
  const txt = localStorage.getItem(STORAGE_NOTAS) || "";
  notasAnaliseEl.value = txt;
  if (txt) {
    notasAnaliseInfoEl.textContent = "Notas carregadas deste dispositivo.";
  } else {
    notasAnaliseInfoEl.textContent = "";
  }
}

function saveNotasAnalise() {
  const txt = notasAnaliseEl.value.trim();
  localStorage.setItem(STORAGE_NOTAS, txt);
  notasAnaliseInfoEl.textContent = "Notas guardadas neste dispositivo.";
  registerBackupMeta("Notas de an√°lise atualizadas");
}

if (notasAnaliseBtn) {
  notasAnaliseBtn.addEventListener("click", () => {
    saveNotasAnalise();
    alert("Notas guardadas.");
  });
}

/* ===== 1RM & TREINOS ===== */
let dataRm = JSON.parse(localStorage.getItem(STORAGE_RM) || "{}");
let rmHistory = JSON.parse(localStorage.getItem(STORAGE_RM_HISTORY) || "{}");
let treinos = JSON.parse(localStorage.getItem(STORAGE_TREINO) || "[]");

/* EXERC√çCIOS ‚Äì MAPAS */
const MOVES_PT = {
  "Chest Press": "Supino com barra",
  "Back Squat": "Agachamento com barra nas costas",
  "Front Squat": "Agachamento frontal",
  "Overhead Squat": "Agachamento acima da cabe√ßa",
  "Deadlift": "Peso morto",
  "Sumo Deadlift": "Peso morto sumo",
  "Romanian Deadlift (RDL)": "Peso morto romeno",
  "Power Clean": "Power clean",
  "Squat Clean": "Squat clean",
  "Clean & Jerk": "Clean & jerk",
  "Power Snatch": "Power snatch",
  "Squat Snatch": "Squat snatch",
  "Push Press": "Push press",
  "Push Jerk": "Push jerk",
  "Split Jerk": "Split jerk",
  "Strict Press": "Press militar estrito",
  "Thruster": "Thruster",
  "Barbell Row": "Remada com barra",
  "Bent Over Row": "Remada inclinada",
  "Good Morning": "Good morning",
  "Lunges com barra": "Passadas com barra",
  "Hip Thrust com barra": "Hip thrust com barra",
  "Dumbbell Press": "Press com halteres",
  "Dumbbell Bench Press": "Supino com halteres",
  "Dumbbell Snatch": "Snatch com halteres",
  "Dumbbell Clean": "Clean com halteres",
  "Dumbbell Clean & Jerk": "Clean & jerk com halteres",
  "Dumbbell Thruster": "Thruster com halteres",
  "Dumbbell Row": "Remada com halteres",
  "Dumbbell Lunges": "Passadas com halteres",
  "Kettlebell Swing": "Swing com kettlebell",
  "Kettlebell Clean": "Clean com kettlebell",
  "Kettlebell Snatch": "Snatch com kettlebell",
  "Goblet Squat": "Agachamento goblet",
  "Kettlebell Lunges": "Passadas com kettlebell"
};

/* GUIA ‚Äì LISTA TIPO JSON (inclui mais exerc√≠cios que MOVES) */
const EXER_INFO = [
  { en: "Chest Press", pt: "Supino com barra", descricao: "Empurrar a barra para longe do peito, deitado no banco, controlando a descida e a subida." },
  { en: "Back Squat", pt: "Agachamento com barra nas costas", descricao: "Agachamento com a barra apoiada nas costas, descendo at√© pelo menos √† paralela e subindo com o tronco firme." },
  { en: "Front Squat", pt: "Agachamento frontal", descricao: "Agachamento com a barra apoiada na parte da frente dos ombros, mantendo o tronco mais vertical." },
  { en: "Overhead Squat", pt: "Agachamento acima da cabe√ßa", descricao: "Agachamento com a barra acima da cabe√ßa, bra√ßos estendidos e core bem firme para estabilizar." },
  { en: "Deadlift", pt: "Peso morto", descricao: "Levar a barra do ch√£o at√© √† anca com costas neutras, empurrando o ch√£o com as pernas e contraindo gl√∫teos no topo." },
  { en: "Sumo Deadlift", pt: "Peso morto sumo", descricao: "Peso morto com p√©s mais afastados e m√£os a agarrar a barra entre as pernas, reduzindo a amplitude de anca." },
  { en: "Romanian Deadlift (RDL)", pt: "Peso morto romeno", descricao: "Peso morto com menor flex√£o de joelhos, focado em posteriores da coxa e gl√∫teos, mantendo a barra perto do corpo." },
  { en: "Power Clean", pt: "Power clean", descricao: "Levar a barra do ch√£o at√© aos ombros de forma explosiva, recebendo-a acima da paralela." },
  { en: "Squat Clean", pt: "Squat clean", descricao: "Clean com rece√ß√£o em agachamento completo antes de subir para a posi√ß√£o de p√©." },
  { en: "Clean & Jerk", pt: "Clean & jerk", descricao: "Levar a barra do ch√£o aos ombros (clean) e dos ombros at√© acima da cabe√ßa (jerk) em dois movimentos distintos." },
  { en: "Power Snatch", pt: "Power snatch", descricao: "Arranco com rece√ß√£o acima da paralela, num √∫nico movimento do ch√£o at√© overhead." },
  { en: "Squat Snatch", pt: "Squat snatch", descricao: "Arranco com rece√ß√£o em agachamento profundo, seguido de extens√£o at√© ficar totalmente de p√©." },
  { en: "Push Press", pt: "Push press", descricao: "Press de ombros com pequeno impulso das pernas, terminando com a barra acima da cabe√ßa." },
  { en: "Push Jerk", pt: "Push jerk", descricao: "Impulso de pernas e encaixe da barra acima da cabe√ßa, recebendo em semi-agachamento antes de estender." },
  { en: "Split Jerk", pt: "Split jerk", descricao: "Jerk em passada, recebendo a barra overhead com uma perna √† frente e outra atr√°s para maior estabilidade." },
  { en: "Strict Press", pt: "Press militar estrito", descricao: "Press de ombros sem ajuda das pernas, s√≥ com for√ßa dos ombros e bra√ßos, de p√© ou sentado." },
  { en: "Thruster", pt: "Thruster", descricao: "Agachamento frontal seguido diretamente de press acima da cabe√ßa num √∫nico movimento fluido." },
  { en: "Barbell Row", pt: "Remada com barra", descricao: "Com o tronco inclinado √† frente, puxar a barra em dire√ß√£o ao abd√≥men mantendo as costas neutras." },
  { en: "Bent Over Row", pt: "Remada inclinada", descricao: "Remada com maior inclina√ß√£o do tronco, focando dorsais e parte m√©dia das costas." },
  { en: "Good Morning", pt: "Good morning", descricao: "Com a barra nas costas, inclinar o tronco √† frente com ligeira flex√£o de joelhos e voltar √† posi√ß√£o inicial." },
  { en: "Lunges com barra", pt: "Passadas com barra", descricao: "Passadas √† frente ou atr√°s com a barra apoiada nos ombros, mantendo o tronco direito." },
  { en: "Hip Thrust com barra", pt: "Hip thrust com barra", descricao: "Elevar a anca com as costas apoiadas num banco e a barra sobre a bacia, contraindo bem os gl√∫teos." },
  { en: "Dumbbell Press", pt: "Press com halteres", descricao: "Press de ombros com halteres, de p√© ou sentado, subindo os halteres acima da cabe√ßa." },
  { en: "Dumbbell Bench Press", pt: "Supino com halteres", descricao: "Deitado no banco, empurrar dois halteres para cima a partir do peito, controlando a descida." },
  { en: "Dumbbell Snatch", pt: "Snatch com halteres", descricao: "Do ch√£o at√© acima da cabe√ßa com um haltere, num movimento explosivo e cont√≠nuo." },
  { en: "Dumbbell Clean", pt: "Clean com halteres", descricao: "Levar o haltere do ch√£o ou das pernas at√© ao ombro, com extens√£o de anca." },
  { en: "Dumbbell Clean & Jerk", pt: "Clean & jerk com halteres", descricao: "Sequ√™ncia de clean at√© ao ombro e jerk at√© acima da cabe√ßa, com halteres." },
  { en: "Dumbbell Thruster", pt: "Thruster com halteres", descricao: "Agachamento frontal com halteres seguido de press acima da cabe√ßa." },
  { en: "Dumbbell Row", pt: "Remada com halteres", descricao: "Remada unilateral ou bilateral com halteres, tronco inclinado." },
  { en: "Dumbbell Lunges", pt: "Passadas com halteres", descricao: "Passadas √† frente ou atr√°s segurando halteres nas m√£os." },
  { en: "Kettlebell Swing", pt: "Swing com kettlebell", descricao: "Balan√ßar o kettlebell entre as pernas e projet√°-lo at√© √† altura do peito ou acima da cabe√ßa, com extens√£o explosiva da anca." },
  { en: "Kettlebell Clean", pt: "Clean com kettlebell", descricao: "Levar o kettlebell das pernas at√© √† posi√ß√£o de rack junto ao ombro." },
  { en: "Kettlebell Snatch", pt: "Snatch com kettlebell", descricao: "Do ch√£o ou entre as pernas at√© acima da cabe√ßa num movimento cont√≠nuo." },
  { en: "Goblet Squat", pt: "Agachamento goblet", descricao: "Agachamento com um peso segurado junto ao peito, normalmente um kettlebell ou haltere." },
  { en: "Kettlebell Lunges", pt: "Passadas com kettlebell", descricao: "Passadas segurando kettlebells nas m√£os ou em rack." }
];

const ALL_EXERCISES = Object.keys(MOVES_PT);

/* ===== SELETORES E OP√á√ïES ===== */
function refreshCalcExOptions() {
  if (!calcExerciseEl) return;
  calcExerciseEl.innerHTML = "";
  ALL_EXERCISES.forEach(m => {
    const opt = document.createElement("option");
    opt.value = m;
    opt.textContent = MOVES_PT[m] ? `${m} ‚Äì ${MOVES_PT[m]}` : m;
    calcExerciseEl.appendChild(opt);
  });
}

function refreshGraphExerciseOptions() {
  if (!graphExerciseEl) return;
  graphExerciseEl.innerHTML = "";
  ALL_EXERCISES.forEach(m => {
    const opt = document.createElement("option");
    opt.value = m;
    opt.textContent = MOVES_PT[m] ? `${m} ‚Äì ${MOVES_PT[m]}` : m;
    graphExerciseEl.appendChild(opt);
  });
}

function refreshTreinoExerciseOptions(filter) {
  if (!treinoExEl) return;
  const f = (filter || "").toLowerCase();
  treinoExEl.innerHTML = "";
  ALL_EXERCISES.forEach(m => {
    const label = MOVES_PT[m] ? `${m} ‚Äì ${MOVES_PT[m]}` : m;
    if (f && !label.toLowerCase().includes(f)) return;
    const opt = document.createElement("option");
    opt.value = m;
    opt.textContent = label;
    treinoExEl.appendChild(opt);
  });
}

function initSelects() {
  if (calcExerciseEl) refreshCalcExOptions();
  if (graphExerciseEl) refreshGraphExerciseOptions();
  if (treinoExEl) refreshTreinoExerciseOptions("");
}

/* ===== CALCULADORA DE OBJETIVOS ===== */
if (calcBtn) {
  calcBtn.addEventListener("click", () => {
    const ex = calcExerciseEl.value;
    const currentRm = parseFloat(calcCurrentRmEl.value || "0");
    const targetKgVal = parseFloat(calcTargetRmEl.value || "0");
    const weeksVal = parseInt(calcWeeksEl.value || "0", 10);
    const nivelSel = calcNivelEl.value;

    let msg = "";

    if (!ex) {
      calcResEl.textContent = "Seleciona um exerc√≠cio.";
      return;
    }

    const rmBase = dataRm[ex] || 0;
    const baseParaCalculo = currentRm > 0 ? currentRm : rmBase;

    if (!baseParaCalculo) {
      calcResEl.textContent = "Ainda n√£o tens 1RM registado para este exerc√≠cio. Introduz o 1RM atual ou regista um PR primeiro.";
      return;
    }

    if (!targetKgVal || targetKgVal <= baseParaCalculo) {
      calcResEl.textContent = "Define um objetivo em kg superior ao teu 1RM atual.";
      return;
    }

    const diff = targetKgVal - baseParaCalculo;
    msg += `Atualmente o teu 1RM aproximado em ${MOVES_PT[ex] || ex} √© cerca de ${formatKg(baseParaCalculo)}. `;
    msg += `Pretendes chegar a ${formatKg(targetKgVal)}, ou seja, subir cerca de ${formatKg(diff)}.`;

    let semanas = weeksVal || 0;
    if (!semanas) {
      const minSem = Math.ceil(diff / 1.5);
      const maxSem = Math.ceil(diff / 0.5);
      semanas = Math.min(24, Math.max(4, minSem));
      msg += `\n\nSem prazo definido, um intervalo razo√°vel para esta progress√£o seriam entre 8 e ${maxSem} semanas, dependendo da tua experi√™ncia e consist√™ncia.`;
    } else {
      msg += `\n\nCom o prazo de aproximadamente ${semanas} semanas, precisas de uma progress√£o m√©dia de ${(diff / semanas).toFixed(1).replace(".", ",")} kg por semana.`;
    }

    let dificuldade = "moderado";
    if (diff / semanas > 1.5) dificuldade = "agressivo";
    if (diff / semanas < 0.5) dificuldade = "conservador";

    if (dificuldade === "agressivo") {
      msg += " Est√°s a apontar para uma taxa de progress√£o agressiva; garante sono, alimenta√ß√£o e gest√£o de volume adequados.";
    } else if (dificuldade === "conservador") {
      msg += " A taxa de progress√£o √© conservadora, o que aumenta a probabilidade de manteres boa t√©cnica e recuperares bem.";
    } else {
      msg += " A taxa de progress√£o √© realista para a maioria dos praticantes com treino consistente.";
    }

    if (profile && profile.peso) {
      const relAtual = baseParaCalculo / profile.peso;
      const relTarget = targetKgVal / profile.peso;
      msg += `\n\nAtualmente levantas cerca de ${(relAtual).toFixed(2).replace(".", ",")}√ó o teu peso corporal neste movimento; o objetivo corresponde a ${(relTarget).toFixed(2).replace(".", ",")}√ó.`;
    }

    if (profile && profile.altura && profile.peso) {
      const altura = profile.altura;
      const peso = profile.peso;
      const imc = peso / Math.pow(altura / 100, 2);
      msg += `\n\nCom base no teu IMC aproximado de ${imc.toFixed(1).replace(".", ",")}, vale a pena acompanhar n√£o s√≥ a carga absoluta, mas tamb√©m como o teu peso corporal evolui ao longo do ciclo de treino.`;
    }

    if (nivelSel || profile?.nivel) {
      const nivel = (nivelSel || profile.nivel || "").toLowerCase();
      let freq = "2‚Äì3 sess√µes semanais";
      let seriesReps = "3‚Äì5 s√©ries de 3‚Äì6 repeti√ß√µes entre 75‚Äì90% do 1RM atual";

      if (nivel === "iniciante") {
        freq = "2‚Äì3 sess√µes semanais focadas no movimento principal";
        seriesReps = "3‚Äì4 s√©ries de 5‚Äì8 repeti√ß√µes entre 70‚Äì80% do 1RM atual";
      } else if (nivel === "intermedio") {
        freq = "2‚Äì3 sess√µes semanais com varia√ß√µes do movimento principal";
        seriesReps = "4‚Äì5 s√©ries de 3‚Äì6 repeti√ß√µes entre 75‚Äì85% do 1RM atual";
      } else if (nivel === "avancado") {
        freq = "2‚Äì3 sess√µes semanais mais espec√≠ficas (for√ßa + varia√ß√µes t√©cnicas)";
        seriesReps = "3‚Äì6 s√©ries entre 2‚Äì5 repeti√ß√µes a 80‚Äì90% do 1RM atual";
      }

      msg += `\n\nObjetivo: chegar a ${formatKg(targetKgVal)} em cerca de ${weeksVal} semanas (${dificuldade}). ` +
             `Uma sugest√£o, tendo em conta o teu n√≠vel, √© realizar ${freq} de ${ex}, com ${seriesReps}, ` +
             `aumentando 2,5‚Äì5 kg quando conseguires todas as s√©ries com boa t√©cnica e sem falhas.`;
    } else {
      msg += `\n\nTens como objetivo chegar a ${formatKg(targetKgVal)}. Define um prazo em semanas para obteres uma recomenda√ß√£o mais detalhada de volume e frequ√™ncia.`;
    }

    calcResEl.textContent = msg;
  });
}

/* ===== GR√ÅFICO 1RM ===== */
function updateRmChart() {
  if (!rmChartCanvas || !graphExerciseEl) return;

  const ex = graphExerciseEl.value;
  let labels = [];
  let values = [];

  if (ex && (rmHistory[ex] || dataRm[ex])) {
    const hist = (rmHistory[ex] || []).slice().sort((a, b) => {
      return (a.date || "").localeCompare(b.date || "");
    });

    hist.forEach((entry, idx) => {
      labels.push(entry.date || "h" + (idx + 1));
      values.push(entry.value);
    });

    if (dataRm[ex]) {
      labels.push("Atual");
      values.push(dataRm[ex]);
    }
  }

  const ctx = rmChartCanvas.getContext("2d");

  if (rmChart) {
    rmChart.destroy();
    rmChart = null;
  }

  if (!labels.length) {
    rmChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: ["Sem dados"],
        datasets: [{
          label: "1RM (kg)",
          data: [0],
          tension: 0.25
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: { display: false },
          y: { display: false }
        }
      }
    });
    return;
  }

  rmChart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [{
        label: "1RM (kg)",
        data: values,
        tension: 0.25
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: true }
      },
      scales: {
        x: {
          title: { display: true, text: "Registos" }
        },
        y: {
          title: { display: true, text: "Peso (kg)" },
          beginAtZero: false
        }
      }
    }
  });
}

if (graphExerciseEl) {
  graphExerciseEl.addEventListener("change", updateRmChart);
}

/* ===== WOD ===== */
function saveTreinos() {
  localStorage.setItem(STORAGE_TREINO, JSON.stringify(treinos));
}

function calcCarga(entry) {
  const peso = entry.peso || 0;
  const reps = entry.reps || 0;
  const rondas = entry.rondas || 1;
  return peso * reps * rondas;
}

function addTreinoEntry() {
  const date = treinoDataEl.value || new Date().toISOString().slice(0,10);
  const ex = treinoExEl.value;
  const tipo = treinoTipoEl.value;
  const rondas = parseInt(treinoRondasEl.value || "1", 10);
  const reps = parseInt(treinoRepsEl.value || "0", 10);
  const peso = parseFloat(treinoPesoEl.value || "0");
  const tempo = treinoTempoEl.value.trim();
  const distKmVal = parseFloat(treinoDistEl.value || "0");

  if (!ex || !reps || reps <= 0) return;

  const carga = calcCarga({ peso, reps, rondas });
  let perc1rm = null;
  if (dataRm[ex] && dataRm[ex] > 0 && peso > 0) {
    perc1rm = peso / dataRm[ex];
  }

  const entry = {
    date,
    ex,
    tipo,
    rondas,
    reps,
    peso,
    tempo,
    carga,
    perc1rm,
    distanciaKm: (!isNaN(distKmVal) && distKmVal > 0) ? distKmVal : 0
  };

  treinos.unshift(entry);
  saveTreinos();
  registerBackupMeta("WOD registado");
  renderTreinos();
}

function deleteTreinoEntry(index) {
  if (index < 0 || index >= treinos.length) return;
  if (!confirm("Apagar este registo de WOD?")) return;
  treinos.splice(index, 1);
  saveTreinos();
  registerBackupMeta("WOD removido");
  renderTreinos();
}

function renderDailyHistory() {
  if (!dailyHistoryBody) return;
  dailyHistoryBody.innerHTML = "";

  if (!treinos.length) return;

  const sorted = treinos.slice().sort((a, b) => {
    return (b.date || "").localeCompare(a.date || "");
  });

  sorted.forEach(t => {
    const tr = document.createElement("tr");

    const tdDate = document.createElement("td");
    tdDate.textContent = t.date || "";
    tr.appendChild(tdDate);

    const tdEx = document.createElement("td");
    const label = MOVES_PT[t.ex] ? `${t.ex} ‚Äì ${MOVES_PT[t.ex]}` : t.ex;
    tdEx.textContent = label || "";
    tr.appendChild(tdEx);

    const tdTipo = document.createElement("td");
    tdTipo.textContent = t.tipo || "";
    tr.appendChild(tdTipo);

    const tdR = document.createElement("td");
    tdR.textContent = t.rondas || "";
    tr.appendChild(tdR);

    const tdReps = document.createElement("td");
    tdReps.textContent = t.reps || "";
    tr.appendChild(tdReps);

    const tdPeso = document.createElement("td");
    tdPeso.textContent = t.peso ? formatKg(t.peso) : "";
    tr.appendChild(tdPeso);

    const tdPerc = document.createElement("td");
    if (t.perc1rm) {
      tdPerc.textContent = (t.perc1rm * 100).toFixed(0) + "%";
    } else {
      tdPerc.textContent = "";
    }
    tr.appendChild(tdPerc);

    const tdTempo = document.createElement("td");
    tdTempo.textContent = t.tempo || "";
    tr.appendChild(tdTempo);

    const tdDist = document.createElement("td");
    tdDist.textContent = t.distanciaKm ? formatKm(t.distanciaKm) : "";
    tr.appendChild(tdDist);

    const tdCarga = document.createElement("td");
    tdCarga.textContent = t.carga ? formatKg(t.carga) : "";
    tr.appendChild(tdCarga);

    dailyHistoryBody.appendChild(tr);
  });
}

function renderTreinos() {
  if (!treinosBody) return;
  treinosBody.innerHTML = "";

  const sorted = treinos.slice().sort((a, b) => {
    return (b.date || "").localeCompare(a.date || "");
  });

  sorted.forEach((t, index) => {
    const tr = document.createElement("tr");

    const tdDate = document.createElement("td");
    tdDate.textContent = t.date || "";
    tr.appendChild(tdDate);

    const tdEx = document.createElement("td");
    const label = MOVES_PT[t.ex] ? `${t.ex} ‚Äì ${MOVES_PT[t.ex]}` : t.ex;
    tdEx.textContent = label || "";
    tr.appendChild(tdEx);

    const tdTipo = document.createElement("td");
    tdTipo.textContent = t.tipo || "";
    tr.appendChild(tdTipo);

    const tdR = document.createElement("td");
    tdR.textContent = t.rondas || "";
    tr.appendChild(tdR);

    const tdReps = document.createElement("td");
    tdReps.textContent = t.reps || "";
    tr.appendChild(tdReps);

    const tdPeso = document.createElement("td");
    tdPeso.textContent = t.peso ? formatKg(t.peso) : "";
    tr.appendChild(tdPeso);

    const tdPerc = document.createElement("td");
    if (t.perc1rm) {
      tdPerc.textContent = (t.perc1rm * 100).toFixed(0) + "%";
    } else {
      tdPerc.textContent = "";
    }
    tr.appendChild(tdPerc);

    const tdTempo = document.createElement("td");
    tdTempo.textContent = t.tempo || "";
    tr.appendChild(tdTempo);

    const tdDist = document.createElement("td");
    tdDist.textContent = t.distanciaKm ? formatKm(t.distanciaKm) : "";
    tr.appendChild(tdDist);

    const tdCarga = document.createElement("td");
    tdCarga.textContent = t.carga ? formatKg(t.carga) : "";
    tr.appendChild(tdCarga);

    const tdDel = document.createElement("td");
    const btnDel = document.createElement("button");
    btnDel.className = "btn-delete";
    btnDel.textContent = "üóë";
    btnDel.addEventListener("click", () => deleteTreinoEntry(index));
    tdDel.appendChild(btnDel);
    tr.appendChild(tdDel);

    treinosBody.appendChild(tr);
  });

  renderDailyHistory();
}

/* ===== PERFORMANCE ===== */
function getMonday(dateStr) {
  const d = new Date(dateStr);
  if (isNaN(d.getTime())) return null;
  const day = d.getDay();
  const diff = (day + 6) % 7;
  d.setDate(d.getDate() - diff);
  d.setHours(0, 0, 0, 0);
  return d;
}

function renderWeeklyHistory() {
  if (!weeklyHistoryEl) return;

  if (!treinos.length) {
    weeklyHistoryEl.textContent = "Ainda n√£o h√° hist√≥rico semanal registado.";
    return;
  }

  const semanas = {};
  treinos.forEach(t => {
    if (!t.date) return;
    const mon = getMonday(t.date);
    if (!mon) return;
    const key = mon.toISOString().slice(0,10);
    if (!semanas[key]) semanas[key] = { carga: 0, dist: 0 };
    semanas[key].carga += t.carga || 0;
    if (t.distanciaKm) semanas[key].dist += t.distanciaKm;
  });

  const keys = Object.keys(semanas).sort((a, b) => b.localeCompare(a));

  if (!keys.length) {
    weeklyHistoryEl.textContent = "Ainda n√£o h√° hist√≥rico semanal registado.";
    return;
  }

  const fmt = (d) => {
    const dd = String(d.getDate()).padStart(2, "0");
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    return dd + "/" + mm;
  };

  const lines = keys.slice(0, 4).map(k => {
    const mon = new Date(k);
    const sun = new Date(mon);
    sun.setDate(mon.getDate() + 6);
    const txtCarga = formatKg(semanas[k].carga);
    const txtDist = semanas[k].dist > 0 ? formatKm(semanas[k].dist) : "0 km";
    return `Semana ${fmt(mon)}‚Äì${fmt(sun)}: carga total ${txtCarga} | dist√¢ncia total ${txtDist}`;
  });

  weeklyHistoryEl.innerHTML = lines.join("<br>");
}

function renderPerformance() {
  renderWeeklyHistory();

  const perf1rmBody = document.getElementById("perf1rmBody");
  const perfMetconBody = document.getElementById("perfMetconBody");
  if (!perf1rmBody || !perfMetconBody) return;

  const best1rm = {};
  const metconBest = {};

  treinos.forEach(t => {
    if (!t.ex || !t.date) return;

    if (t.tipo === "For√ßa" && t.peso && t.reps && t.reps <= 5) {
      const est1rm = t.peso * (1 + t.reps / 30);
      if (!best1rm[t.ex] || est1rm > best1rm[t.ex].value) {
        best1rm[t.ex] = { value: est1rm, date: t.date, peso: t.peso, reps: t.reps };
      }
    }

    if (t.tipo === "Metcon" && t.tempo) {
      const key = t.ex;
      if (!metconBest[key]) {
        metconBest[key] = { tempo: t.tempo, date: t.date, carga: t.peso || t.distanciaKm || null };
      } else {
        if (t.tempo < metconBest[key].tempo) {
          metconBest[key] = { tempo: t.tempo, date: t.date, carga: t.peso || t.distanciaKm || null };
        }
      }
    }
  });

  perf1rmBody.innerHTML = "";
  Object.keys(best1rm).forEach(ex => {
    const row = best1rm[ex];
    const tr = document.createElement("tr");
    const tdEx = document.createElement("td");
    tdEx.textContent = MOVES_PT[ex] ? `${ex} ‚Äì ${MOVES_PT[ex]}` : ex;
    tr.appendChild(tdEx);

    const tdVal = document.createElement("td");
    tdVal.textContent = formatKg(row.value);
    tr.appendChild(tdVal);

    const tdDate = document.createElement("td");
    tdDate.textContent = row.date;
    tr.appendChild(tdDate);

    const tdRatio = document.createElement("td");
    if (profile && profile.peso) {
      const ratio = row.value / profile.peso;
      tdRatio.textContent = ratio.toFixed(2).replace(".", ",") + "√ó peso corporal";
    } else {
      tdRatio.textContent = "-";
    }
    tr.appendChild(tdRatio);

    perf1rmBody.appendChild(tr);
  });

  perfMetconBody.innerHTML = "";
  Object.keys(metconBest).forEach(ex => {
    const row = metconBest[ex];
    const tr = document.createElement("tr");

    const tdEx = document.createElement("td");
    tdEx.textContent = MOVES_PT[ex] ? `${ex} ‚Äì ${MOVES_PT[ex]}` : ex;
    tr.appendChild(tdEx);

    const tdTempo = document.createElement("td");
    tdTempo.textContent = row.tempo;
    tr.appendChild(tdTempo);

    const tdDate = document.createElement("td");
    tdDate.textContent = row.date;
    tr.appendChild(tdDate);

    const tdCarga = document.createElement("td");
    if (row.carga) {
      if (row.carga > 5) {
        tdCarga.textContent = formatKg(row.carga);
      } else {
        tdCarga.textContent = formatKm(row.carga);
      }
    } else {
      tdCarga.textContent = "-";
    }
    tr.appendChild(tdCarga);

    perfMetconBody.appendChild(tr);
  });
}

/* ===== RESERVAS & PRESEN√áAS ===== */
function saveReservas() {
  localStorage.setItem(STORAGE_RESERVAS, JSON.stringify(reservas));
}

function savePresencas() {
  localStorage.setItem(STORAGE_PRESENCAS, JSON.stringify(presencas));
}

function saveRankings() {
  localStorage.setItem(STORAGE_RANKINGS, JSON.stringify(rankingsMensais));
}

function gerarIdReserva() {
  return "res_" + Date.now() + "_" + Math.floor(Math.random() * 100000);
}

function renderReservasResumo() {
  if (!reservasResumoEl) return;
  if (!reservas.length) {
    reservasResumoEl.textContent = "Ainda n√£o tens reservas registadas.";
    return;
  }

  const total = reservas.length;
  const pres = presencas.length;
  reservasResumoEl.textContent = `Total de reservas: ${total} | Presen√ßas marcadas: ${pres}`;
}

function renderReservas() {
  if (!reservasBody) return;
  reservasBody.innerHTML = "";

  const sorted = reservas.slice().sort((a, b) => {
    const d1 = (a.data || "") + (a.hora || "");
    const d2 = (b.data || "") + (b.hora || "");
    return d2.localeCompare(d1);
  });

  sorted.forEach(r => {
    const tr = document.createElement("tr");

    const tdData = document.createElement("td");
    tdData.textContent = r.data || "";
    tr.appendChild(tdData);

    const tdHora = document.createElement("td");
    tdHora.textContent = r.hora || "";
    tr.appendChild(tdHora);

    const tdTipo = document.createElement("td");
    tdTipo.textContent = r.tipo || "";
    tr.appendChild(tdTipo);

    const tdNota = document.createElement("td");
    tdNota.textContent = r.nota || "";
    tr.appendChild(tdNota);

    const tdPres = document.createElement("td");
    const temPresenca = presencas.some(p => p.reservaId === r.id);
    if (temPresenca) {
      tdPres.textContent = "Presente ‚úÖ";
    } else {
      const btnPres = document.createElement("button");
      btnPres.className = "btn-secondary";
      btnPres.style.padding = "4px 8px";
      btnPres.style.fontSize = "0.7rem";
      btnPres.textContent = "Marcar presen√ßa";
      btnPres.addEventListener("click", () => marcarPresenca(r.id));
      tdPres.appendChild(btnPres);
    }
    tr.appendChild(tdPres);

    const tdDel = document.createElement("td");
    const btnDel = document.createElement("button");
    btnDel.className = "btn-delete";
    btnDel.textContent = "üóë";
    btnDel.addEventListener("click", () => apagarReserva(r.id));
    tdDel.appendChild(btnDel);
    tr.appendChild(tdDel);

    reservasBody.appendChild(tr);
  });

  renderReservasResumo();
}

function marcarPresenca(reservaId) {
  const existe = presencas.some(p => p.reservaId === reservaId);
  if (existe) return;

  presencas.push({
    reservaId,
    dataMarcacao: new Date().toISOString()
  });
  savePresencas();
  registerBackupMeta("Presen√ßa marcada");
  renderReservas();
  atualizarRankingsMensais();
}

function apagarReserva(reservaId) {
  if (!confirm("Apagar esta reserva?")) return;
  reservas = reservas.filter(r => r.id !== reservaId);
  presencas = presencas.filter(p => p.reservaId !== reservaId);
  saveReservas();
  savePresencas();
  registerBackupMeta("Reserva removida");
  renderReservas();
  atualizarRankingsMensais();
}

function atualizarRankingsMensais() {
  const agora = new Date();
  const ano = agora.getFullYear();
  const mes = agora.getMonth() + 1;

  const reservasMes = reservas.filter(r => mesmoMesAno(r.data, ano, mes));
  const presencasMes = presencas.filter(p => {
    const reserva = reservas.find(r => r.id === p.reservaId);
    return reserva && mesmoMesAno(reserva.data, ano, mes);
  });

  rankingsMensais = rankingsMensais.filter(r => !(r.ano === ano && r.mes === mes));

  rankingsMensais.push({
    ano,
    mes,
    totalReservas: reservasMes.length,
    totalPresencas: presencasMes.length
  });

  saveRankings();
}

function adicionarReserva() {
  const data = reservaDataEl.value || new Date().toISOString().slice(0,10);
  const hora = reservaHoraEl.value || "";
  const tipo = reservaTipoEl.value || "";
  const nota = reservaNotaEl.value.trim();

  if (!data || !hora || !tipo) {
    alert("Preenche pelo menos data, hora e tipo de aula.");
    return;
  }

  const novaReserva = {
    id: gerarIdReserva(),
    data,
    hora,
    tipo,
    nota,
    inscritos: profile && profile.nome ? [profile.nome] : []
  };

  reservas.unshift(novaReserva);
  saveReservas();
  reservaNotaEl.value = "";
  registerBackupMeta("Reserva registada");
  renderReservas();
  atualizarRankingsMensais();
}

if (reservaAddBtn) {
  reservaAddBtn.addEventListener("click", adicionarReserva);
}

function mesmoMesAno(dataISO, ano, mes) {
  const d = new Date(dataISO);
  if (isNaN(d.getTime())) return false;
  return d.getFullYear() === ano && (d.getMonth() + 1) === mes;
}

/* ===== GUIA EXERC√çCIOS ===== */
function renderGuiaExercicios() {
  if (!guiaBody) return;
  guiaBody.innerHTML = "";

  const filtro = (guiaSearch?.value || "").toLowerCase().trim();

  EXER_INFO.forEach(ex => {
    const texto = (ex.en + " " + ex.pt + " " + ex.descricao).toLowerCase();
    if (filtro && !texto.includes(filtro)) return;

    const tr = document.createElement("tr");
    const tdEn = document.createElement("td");
    tdEn.textContent = ex.en;
    tr.appendChild(tdEn);

    const tdPt = document.createElement("td");
    tdPt.textContent = ex.pt;
    tr.appendChild(tdPt);

    const tdDesc = document.createElement("td");
    tdDesc.textContent = ex.descricao;
    tr.appendChild(tdDesc);

    guiaBody.appendChild(tr);
  });
}

if (guiaSearch) {
  guiaSearch.addEventListener("input", renderGuiaExercicios);
}

/* ===== BACKUP ===== */
function formatDateTime(iso) {
  const d = new Date(iso);
  if (isNaN(d.getTime())) return iso;
  const dd = String(d.getDate()).padStart(2, "0");
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const yyyy = d.getFullYear();
  const hh = String(d.getHours()).padStart(2, "0");
  const min = String(d.getMinutes()).padStart(2, "0");
  return `${dd}/${mm}/${yyyy} ${hh}:${min}`;
}

function registerBackupMeta(evento) {
  try {
    const meta = JSON.parse(localStorage.getItem(STORAGE_BACKUP_META) || "{}");
    meta.lastChange = new Date().toISOString();
    meta.lastEvent = evento || "";
    localStorage.setItem(STORAGE_BACKUP_META, JSON.stringify(meta));
    updateBackupInfo();
  } catch (e) {}
}

function updateBackupInfo() {
  if (!backupInfoEl) return;
  const meta = JSON.parse(localStorage.getItem(STORAGE_BACKUP_META) || "{}");
  const lastBackup = meta.lastBackup ? formatDateTime(meta.lastBackup) : "nunca";
  const lastChange = meta.lastChange ? formatDateTime(meta.lastChange) : "sem registo";
  backupInfoEl.innerHTML =
    `<div class="helper-text">
       √öltimo backup exportado: <strong>${lastBackup}</strong><br>
       √öltima altera√ß√£o de dados: <strong>${lastChange}</strong>
     </div>`;
}

function buildBackupObject() {
  return {
    version: 2,
    createdAt: new Date().toISOString(),
    profile: profile || {},
    dataRm: dataRm || {},
    rmHistory: rmHistory || {},
    treinos: treinos || [],
    reservas: reservas || [],
    presencas: presencas || [],
    rankingsMensais: rankingsMensais || []
  };
}

function downloadJson(obj, filename) {
  const dataStr = "data:application/json;charset=utf-8," + encodeURIComponent(JSON.stringify(obj));
  const a = document.createElement("a");
  a.setAttribute("href", dataStr);
  a.setAttribute("download", filename);
  document.body.appendChild(a);
  a.click();
  a.remove();
}

if (exportBackupBtn) {
  exportBackupBtn.addEventListener("click", () => {
    const backup = buildBackupObject();
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth() + 1).padStart(2, "0");
    const dd = String(now.getDate()).padStart(2, "0");
    const filename = `crossfit_backup_${yyyy}${mm}${dd}.json`;
    downloadJson(backup, filename);

    try {
      const meta = JSON.parse(localStorage.getItem(STORAGE_BACKUP_META) || "{}");
      meta.lastBackup = new Date().toISOString();
      localStorage.setItem(STORAGE_BACKUP_META, JSON.stringify(meta));
    } catch (e) {}
    updateBackupInfo();
    alert("Backup exportado. Podes agora guardar o ficheiro em Google Drive, iCloud, Ficheiros, etc.");
  });
}

if (importBackupBtn && backupFileInput) {
  importBackupBtn.addEventListener("click", () => {
    backupFileInput.value = "";
    backupFileInput.click();
  });

  backupFileInput.addEventListener("change", (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(evt) {
      try {
        const content = evt.target.result;
        const data = JSON.parse(content);

        if (!data || typeof data !== "object") {
          alert("Ficheiro inv√°lido.");
          return;
        }

        if (!("dataRm" in data) && !("treinos" in data)) {
          alert("Este ficheiro n√£o parece ser um backup v√°lido da app.");
          return;
        }

        profile = data.profile || {};
        dataRm = data.dataRm || {};
        rmHistory = data.rmHistory || {};
        treinos = data.treinos || [];
        reservas = data.reservas || [];
        presencas = data.presencas || [];
        rankingsMensais = data.rankingsMensais || [];

        localStorage.setItem(STORAGE_PROFILE, JSON.stringify(profile));
        localStorage.setItem(STORAGE_RM, JSON.stringify(dataRm));
        localStorage.setItem(STORAGE_RM_HISTORY, JSON.stringify(rmHistory));
        localStorage.setItem(STORAGE_TREINO, JSON.stringify(treinos));
        localStorage.setItem(STORAGE_RESERVAS, JSON.stringify(reservas));
        localStorage.setItem(STORAGE_PRESENCAS, JSON.stringify(presencas));
        localStorage.setItem(STORAGE_RANKINGS, JSON.stringify(rankingsMensais));

        registerBackupMeta("Backup importado");

        loadProfile();
        renderRm();
        refreshCalcExOptions();
        refreshGraphExerciseOptions();
        renderTreinos();
        renderReservas();

        alert("Backup importado com sucesso.");
      } catch (err) {
        console.error(err);
        alert("Erro ao ler o ficheiro de backup.");
      }
    };
    reader.readAsText(file);
  });
}

/* GUIA EXERC√çCIOS */
function renderRm() {
  // placeholder para manter compat com chamadas existentes
}

/* TABS PRINCIPAIS */
tabButtons.forEach(btn => {
  btn.addEventListener("click", () => {
    tabButtons.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    const target = btn.dataset.target;
    sections.forEach(s => s.classList.remove("active"));
    const sec = document.getElementById(target);
    if (sec) sec.classList.add("active");
  });
});

/* OP√á√ïES (sub-se√ß√µes) */
document.querySelectorAll(".opt-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    const target = btn.dataset.target;

    // Esconde as subsec√ß√µes do WOD & Tools
    document.querySelectorAll(".option-section").forEach(s => s.classList.remove("active"));

    // Ativa a op√ß√£o normal (WOD, Objetivo, Gr√°ficos, etc.) se for uma option-section
    const sec = document.getElementById(target);
    if (sec && sec.classList.contains("option-section")) {
      sec.classList.add("active");
    }

    // Caso especial: bot√£o "Reservas" dentro do WOD & Tools
    if (target === "sec-reservas" && typeof reservasSection !== "undefined" && reservasSection) {
      reservasSection.style.display = "block";
    }
  });
});

/* BOT√ÉO RESERVAS ‚Äì abre/fecha card de reservas no ecr√£ principal */
if (typeof reservasBtn !== "undefined" && reservasBtn && reservasSection) {
  reservasBtn.addEventListener("click", () => {
    const visivel = reservasSection.style.display === "block";
    reservasSection.style.display = visivel ? "none" : "block";
  });
}

/* INIT */
initSelects();
loadProfile();
renderRm();
refreshCalcExOptions();
refreshGraphExerciseOptions();
loadNotasAnalise();

if (treinoDataEl && !treinoDataEl.value) {
  treinoDataEl.value = new Date().toISOString().slice(0, 10);
}
renderTreinos();
updateBackupInfo();
renderGuiaExercicios();
renderPerformance();
renderReservas();
atualizarRankingsMensais();

if ("serviceWorker" in navigator) {
  window.addEventListener("load", function () {
    navigator.serviceWorker.register("service-worker.js");
  });
}
</script>

</body>
</html>
